name: Publish to MCP Registry

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: macos-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Build release binary
        run: swift build -c release

      - name: Calculate SHA-256
        id: sha256
        run: |
          SHA256=$(openssl dgst -sha256 .build/release/periphery-mcp-server | awk '{print $2}')
          echo "hash=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA-256: $SHA256"

      - name: Update server.json with hash
        run: |
          # Get version from tag or use 1.0.0
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          # Update server.json
          cat > server.json << EOF
          {
            "\$schema": "https://static.modelcontextprotocol.io/schemas/2025-10-17/server.schema.json",
            "name": "io.github.zyntx-lab/periphery-mcp-server",
            "title": "Periphery Code Audit",
            "description": "Swift code analysis with Periphery - detect unused code and improve code quality",
            "version": "${VERSION}",
            "repository": {
              "type": "git",
              "url": "https://github.com/zyntx-lab/periphery-mcp-server"
            },
            "websiteUrl": "https://github.com/zyntx-lab/periphery-mcp-server",
            "packages": [
              {
                "registryType": "mcpb",
                "identifier": "https://github.com/zyntx-lab/periphery-mcp-server/releases/download/v${VERSION}/periphery-mcp-server",
                "version": "${VERSION}",
                "fileSha256": "${{ steps.sha256.outputs.hash }}",
                "transport": {
                  "type": "stdio"
                },
                "runtimeHint": "binary"
              }
            ],
            "_meta": {
              "io.modelcontextprotocol.registry/publisher-provided": {
                "license": "MIT",
                "categories": ["code-analysis", "development-tools"],
                "capabilities": {
                  "tools": [
                    {
                      "name": "check_periphery_installed",
                      "description": "Verify Periphery CLI is installed and accessible"
                    },
                    {
                      "name": "get_periphery_version",
                      "description": "Get the installed version of Periphery"
                    },
                    {
                      "name": "scan_project",
                      "description": "Run a basic Periphery scan on a project"
                    },
                    {
                      "name": "scan_with_config",
                      "description": "Run Periphery scan using a YAML configuration file"
                    },
                    {
                      "name": "analyze_unused_imports",
                      "description": "Focus specifically on detecting unused imports"
                    },
                    {
                      "name": "find_redundant_public",
                      "description": "Identify public declarations that could be internal"
                    },
                    {
                      "name": "scan_with_options",
                      "description": "Advanced scanning with custom Periphery flags"
                    }
                  ]
                },
                "platform": "darwin-arm64",
                "vendor": {
                  "name": "Zyntx Lab",
                  "url": "https://github.com/zyntx-lab"
                }
              }
            }
          }
          EOF

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          gh release create "$GITHUB_REF_NAME" \
            .build/release/periphery-mcp-server#periphery-mcp-server \
            --title "v${VERSION} - Periphery MCP Server" \
            --notes "## Periphery MCP Server v${VERSION}

          A Model Context Protocol server that wraps the Periphery tool for Swift code analysis.

          ### Features
          - 7 MCP tools for comprehensive code analysis
          - CLI integration for stability
          - JSON output for AI interpretation
          - Support for Xcode projects and Swift Packages

          ### Installation

          \`\`\`bash
          # Download and install
          curl -L https://github.com/zyntx-lab/periphery-mcp-server/releases/download/v${VERSION}/periphery-mcp-server \\\\
            -o /usr/local/bin/periphery-mcp-server
          chmod +x /usr/local/bin/periphery-mcp-server
          \`\`\`

          ### Configuration

          Add to \`~/Library/Application Support/Claude/claude_desktop_config.json\`:

          \`\`\`json
          {
            \"mcpServers\": {
              \"periphery\": {
                \"command\": \"/usr/local/bin/periphery-mcp-server\"
              }
            }
          }
          \`\`\`

          Then restart Claude Desktop.

          ### SHA-256
          \`${{ steps.sha256.outputs.hash }}\`

          See README for full documentation and usage examples."

      - name: Install mcp-publisher
        run: brew install mcp-publisher

      - name: Publish to MCP Registry
        run: |
          # Use github-oidc authentication (works in GitHub Actions)
          mcp-publisher login github-oidc
          mcp-publisher publish
